---
- name: Add Missing Modules to Existing Database (Non-Destructive, Remote Docker)
  hosts: "{{ vm_name }}_user"
  become: true
  vars:
    mongodb_container_name: "dutch_external_app_mongodb"
    database_name: "external_system"
    app_user: "external_app_user"
    app_password: "6R3jjsvVhIRP20zMiHdkBzNKx"

    # MongoDB connection details for VPS Docker host
    mongodb_host: "localhost"
    mongodb_port: "27018"  # Host port mapped to MongoDB
    mongodb_auth_db: "external_system"

  tasks:
    - name: Wait for MongoDB container to be ready
      shell: docker exec {{ mongodb_container_name }} mongosh --eval "db.adminCommand('ping')" --quiet
      register: mongodb_ready
      retries: 30
      delay: 2
      until: mongodb_ready.rc == 0
      changed_when: mongodb_ready.rc == 0

    - name: Create module update script
      copy:
        dest: "/tmp/add_missing_modules.js"
        content: |
          // MongoDB Module Update Script
          // Adds missing modules to existing users without erasing data
          
          // Switch to the external_system database
          db = db.getSiblingDB('external_system');
          
          print("ğŸ”§ Adding Missing Modules to Existing Database...");
          print("=============================================");
          
          // Get current timestamp
          var currentTime = new Date();
          
          // ========================================
          // 1. UPDATE USER_MODULES REGISTRY
          // ========================================
          print("\nğŸ“‹ Step 1: Updating user_modules registry...");
          
          // Check and add in_app_purchases module
          var inAppPurchasesModule = db.user_modules.findOne({ "module_name": "in_app_purchases" });
          if (!inAppPurchasesModule) {
            print("  â• Adding in_app_purchases module to registry...");
            db.user_modules.insertOne({
              "_id": ObjectId("507f1f77bcf86cd799439104"),
              "module_name": "in_app_purchases",
              "display_name": "In-App Purchases Module",
              "description": "In-app purchase and subscription management",
              "status": "active",
              "version": "1.0.0",
              "schema": {
                "enabled": "boolean",
                "active_purchases": "array",
                "subscription_status": "string",
                "last_purchase_date": "date",
                "total_spent": "number",
                "currency": "string",
                "last_updated": "date"
              },
              "created_at": currentTime,
              "updated_at": currentTime
            });
            print("  âœ… in_app_purchases module added to registry");
          } else {
            print("  âœ“ in_app_purchases module already exists in registry");
          }
          
          // Check and add dutch_game module
          var dutchGameModule = db.user_modules.findOne({ "module_name": "dutch_game" });
          if (!dutchGameModule) {
            print("  â• Adding dutch_game module to registry...");
            db.user_modules.insertOne({
              "_id": ObjectId("507f1f77bcf86cd799439105"),
              "module_name": "dutch_game",
              "display_name": "Dutch Game Module",
              "description": "Dutch card game statistics and progression",
              "status": "active",
              "version": "1.0.0",
              "schema": {
                "enabled": "boolean",
                "wins": "number",
                "losses": "number",
                "total_matches": "number",
                "points": "number",
                "coins": "number",
                "level": "number",
                "rank": "string",
                "win_rate": "number",
                "subscription_tier": "string",
                "last_match_date": "date",
                "last_updated": "date"
              },
              "created_at": currentTime,
              "updated_at": currentTime
            });
            print("  âœ… dutch_game module added to registry");
          } else {
            // Check if coins field exists in schema, if not add it
            var needsSchemaUpdate = false;
            var schemaUpdates = {};
            
            if (!dutchGameModule.schema || !dutchGameModule.schema.coins) {
              needsSchemaUpdate = true;
              schemaUpdates["schema.coins"] = "number";
            }
            
            // Check if subscription_tier field exists in schema, if not add it
            if (!dutchGameModule.schema || !dutchGameModule.schema.subscription_tier) {
              needsSchemaUpdate = true;
              schemaUpdates["schema.subscription_tier"] = "string";
            }
            
            if (needsSchemaUpdate) {
              print("  ğŸ”„ Updating dutch_game module schema to include missing fields...");
              schemaUpdates["updated_at"] = currentTime;
              db.user_modules.updateOne(
                { "module_name": "dutch_game" },
                { "$set": schemaUpdates }
              );
              print("  âœ… dutch_game module schema updated with missing fields");
            } else {
              print("  âœ“ dutch_game module already exists in registry with all required fields");
            }
          }
          
          // ========================================
          // 2. UPDATE EXISTING USERS
          // ========================================
          print("\nğŸ‘¥ Step 2: Updating existing users with missing modules...");
          
          var usersUpdated = 0;
          var usersSkipped = 0;
          
          // Find all users
          var users = db.users.find({}).toArray();
          print("  Found " + users.length + " users to check");
          
          users.forEach(function(user) {
            var needsUpdate = false;
            var updateFields = {};
            
            // Check for profile.picture field
            if (!user.profile || user.profile.picture === undefined) {
              needsUpdate = true;
              if (!user.profile) {
                updateFields["profile"] = {};
              }
              updateFields["profile.picture"] = "";
              print("  ğŸ”„ Adding picture field to profile for user: " + user.username + " (" + user.email + ")");
            }
            
            // Check for in_app_purchases module
            if (!user.modules || !user.modules.in_app_purchases) {
              needsUpdate = true;
              updateFields["modules.in_app_purchases"] = {
                "enabled": true,
                "active_purchases": [],
                "subscription_status": "none",
                "last_purchase_date": null,
                "total_spent": 0,
                "currency": "USD",
                "last_updated": currentTime
              };
              print("  â• Adding in_app_purchases to user: " + user.username + " (" + user.email + ")");
            }
            
            // Check for dutch_game module
            if (!user.modules || !user.modules.dutch_game) {
              needsUpdate = true;
              updateFields["modules.dutch_game"] = {
                "enabled": true,
                "wins": 0,
                "losses": 0,
                "total_matches": 0,
                "points": 0,
                "coins": 0,
                "level": 1,
                "rank": "beginner",
                "win_rate": 0.0,
                "subscription_tier": "promotional",
                "last_match_date": null,
                "last_updated": currentTime
              };
              print("  â• Adding dutch_game to user: " + user.username + " (" + user.email + ")");
            } else if (user.modules.dutch_game) {
              // Update existing dutch_game module to add missing fields (coins, subscription_tier)
              var needsDutchUpdate = false;
              if (user.modules.dutch_game.coins === undefined) {
                needsUpdate = true;
                needsDutchUpdate = true;
                updateFields["modules.dutch_game.coins"] = 0;
                print("  ğŸ”„ Adding coins field to existing dutch_game for user: " + user.username + " (" + user.email + ")");
              }
              if (user.modules.dutch_game.subscription_tier === undefined) {
                needsUpdate = true;
                needsDutchUpdate = true;
                updateFields["modules.dutch_game.subscription_tier"] = "promotional";
                print("  ğŸ”„ Adding subscription_tier field to existing dutch_game for user: " + user.username + " (" + user.email + ")");
              } else if (user.modules.dutch_game.subscription_tier === "free") {
                // Update old "free" values to "promotional"
                needsUpdate = true;
                needsDutchUpdate = true;
                updateFields["modules.dutch_game.subscription_tier"] = "promotional";
                print("  ğŸ”„ Updating subscription_tier from 'free' to 'promotional' for user: " + user.username + " (" + user.email + ")");
              }
              if (needsDutchUpdate) {
                updateFields["modules.dutch_game.last_updated"] = currentTime;
              }
            }
            
            // Update user if needed
            if (needsUpdate) {
              // Ensure modules object exists
              if (!user.modules) {
                updateFields["modules"] = {};
              }
              
              // Build update query
              var updateQuery = { "$set": updateFields };
              updateQuery["$set"]["updated_at"] = currentTime;
              
              db.users.updateOne(
                { "_id": user._id },
                updateQuery
              );
              usersUpdated++;
            } else {
              usersSkipped++;
            }
          });
          
          print("\n  âœ… Users updated: " + usersUpdated);
          print("  âœ“ Users already up-to-date: " + usersSkipped);
          
          // ========================================
          // 3. ADD is_comp_player FIELD TO USERS
          // ========================================
          print("\nğŸ¤– Step 3: Adding is_comp_player field to users...");
          
          // Create index for is_comp_player field
          try {
            db.users.createIndex({ "is_comp_player": 1 });
            print("  âœ… Created index on is_comp_player field");
          } catch (e) {
            // Index might already exist, that's okay
            print("  âœ“ Index on is_comp_player field already exists or created");
          }
          
          // Update all users to add is_comp_player: false if missing
          var compPlayerUpdateResult = db.users.updateMany(
            { "is_comp_player": { $exists: false } },
            { $set: { "is_comp_player": false, "updated_at": currentTime } }
          );
          
          if (compPlayerUpdateResult.modifiedCount > 0) {
            print("  âœ… Added is_comp_player: false to " + compPlayerUpdateResult.modifiedCount + " users");
          } else {
            print("  âœ“ All users already have is_comp_player field");
          }
          
          // Verify the field exists
          var usersWithField = db.users.countDocuments({ "is_comp_player": { $exists: true } });
          var totalUsers = db.users.countDocuments({});
          print("  ğŸ“Š Users with is_comp_player field: " + usersWithField + " / " + totalUsers);
          
          // ========================================
          // FINAL SUMMARY
          // ========================================
          print("\nğŸ‰ MODULE UPDATE COMPLETE!");
          print("=============================================");
          print("Summary:");
          print("- User modules registry: " + db.user_modules.countDocuments() + " modules");
          print("- Users in database: " + db.users.countDocuments());
          print("- Users updated: " + usersUpdated);
          print("- Users skipped (already up-to-date): " + usersSkipped);
          
          print("\nâœ… All missing modules have been added to existing users!");
        mode: '0644'

    - name: Copy update script to MongoDB container
      shell: docker cp /tmp/add_missing_modules.js {{ mongodb_container_name }}:/tmp/add_missing_modules.js
      register: copy_result
      changed_when: copy_result.rc == 0

    - name: Execute module update script
      shell: |
        docker exec {{ mongodb_container_name }} mongosh -u {{ app_user }} -p "{{ app_password }}" --authenticationDatabase {{ mongodb_auth_db }} --eval "$(cat /tmp/add_missing_modules.js)"
      register: update_result
      changed_when: true

    - name: Display update results
      debug:
        msg: "{{ update_result.stdout }}"

    - name: Verify module updates
      shell: |
        docker exec {{ mongodb_container_name }} mongosh -u {{ app_user }} -p "{{ app_password }}" --authenticationDatabase {{ mongodb_auth_db }} --eval "
          db = db.getSiblingDB('external_system');
          print('\\nğŸ“Š VERIFICATION SUMMARY:');
          print('=====================');
          print('Registered modules: ' + db.user_modules.countDocuments());
          print('Total users: ' + db.users.countDocuments());
          
          // Count users with each module
          var usersWithInApp = db.users.countDocuments({ 'modules.in_app_purchases': { \$exists: true } });
          var usersWithDutch = db.users.countDocuments({ 'modules.dutch_game': { \$exists: true } });
          
          print('Users with in_app_purchases: ' + usersWithInApp);
          print('Users with dutch_game: ' + usersWithDutch);
          
          // Verify is_comp_player field
          var usersWithCompPlayerField = db.users.countDocuments({ 'is_comp_player': { \$exists: true } });
          var compPlayersCount = db.users.countDocuments({ 'is_comp_player': true });
          var humanPlayersCount = db.users.countDocuments({ 'is_comp_player': false });
          
          print('\\nğŸ¤– Comp Player Field Status:');
          print('Users with is_comp_player field: ' + usersWithCompPlayerField);
          print('Computer players (is_comp_player: true): ' + compPlayersCount);
          print('Human players (is_comp_player: false): ' + humanPlayersCount);
          
          // List comp players
          if (compPlayersCount > 0) {
            print('\\nğŸ¤– Computer Players:');
            db.users.find({ \"is_comp_player\": true }, { username: 1, email: 1, \"modules.dutch_game.coins\": 1 }).forEach(function(player) {
              var coins = player.modules && player.modules.dutch_game ? player.modules.dutch_game.coins : 0;
              var playerInfo = \"  - \" + player.username + \" (\" + player.email + \") - \" + coins + \" coins\";
              print(playerInfo);
            });
          }
          
          // List registered modules
          print('\\nğŸ“‹ Registered Modules:');
          db.user_modules.find({}, { module_name: 1, display_name: 1, status: 1 }).forEach(function(module) {
            print('  - ' + module.module_name + ' (' + module.display_name + ') - ' + module.status);
          });
        "
      register: verification_summary
      changed_when: false

    - name: Display verification summary
      debug:
        msg: "{{ verification_summary.stdout }}"

    - name: Clean up temporary files
      file:
        path: "/tmp/add_missing_modules.js"
        state: absent

    - name: Display completion message
      debug:
        msg: |
          âœ… Module Update Playbook Complete!
          
          ğŸ“‹ What was done:
          - Added missing modules to user_modules registry (if needed)
          - Updated existing users with missing modules (in_app_purchases, dutch_game)
          - Added is_comp_player field to all users (default: false)
          - Created index on is_comp_player field
          - Preserved all existing user data
          - No collections were dropped or erased
          
          ğŸ”§ Modules Added:
          - in_app_purchases: In-app purchase and subscription management
          - dutch_game: Dutch card game statistics and progression
          
          ğŸ¤– New Field Added:
          - is_comp_player: Boolean field to identify computer players (default: false)
          
          ğŸ“ Note:
          - Computer players can be added using the 11_add_players.py script
          
          ğŸ“Š Database Status:
          - Container: {{ mongodb_container_name }}
          - Database: {{ database_name }}
          - All existing data preserved
          
          âœ… Your database is now up-to-date with all required modules!
