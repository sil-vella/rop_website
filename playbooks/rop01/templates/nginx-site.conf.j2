# Nginx configuration for {{ item.domain }}
# This is a basic template - customize as needed

{% if item.www_domain is defined %}
# Redirect www to non-www (or vice versa)
server {
    listen 80;
    listen [::]:80;
    server_name {{ item.www_domain }};

    # Let Certbot handle this during SSL setup
    location / {
        return 301 http://{{ item.domain }}$request_uri;
    }
}
{% endif %}

# Main server block
server {
    listen 80;
    listen [::]:80;
    server_name {{ item.domain }};

    # Root directory
    root {{ item.root_dir | default('/var/www/' + item.domain) }};
    index index.html index.htm;

    # Logging
    access_log /var/log/nginx/{{ item.domain }}.access.log;
    error_log /var/log/nginx/{{ item.domain }}.error.log;

    {% if item.backend_port is defined %}
    # Static sponsors directory for card back images and other sponsor content
    # Must come BEFORE location / to ensure it matches first
    location /sponsors/ {
        alias {{ item.root_dir | default('/var/www/' + item.domain) }}/sponsors/;
        autoindex off;
        expires 7d;
        add_header Cache-Control "public";
        # CORS headers for Flutter web image loading
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        # Handle OPTIONS preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Static sim_players/images directory for simulated player profile pictures
    # Must come BEFORE location / to ensure it matches first
    location /sim_players/ {
        alias {{ item.root_dir | default('/var/www/' + item.domain) }}/sim_players/;
        autoindex off;
        expires 7d;
        add_header Cache-Control "public";
        # CORS headers for Flutter web image loading
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        # Handle OPTIONS preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    {% if item.backend_ws_port is defined %}
    # WebSocket proxy to Dart game server
    # Must come BEFORE location / to ensure it matches first
    location /ws {
        proxy_pass http://127.0.0.1:{{ item.backend_ws_port }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    {% endif %}

    {% if item.serve_flutter_web is defined and item.serve_flutter_web %}
    # Flutter web app mode: Proxy API routes to Flask, serve Flutter files for everything else
    
    # Explicit API routes - proxy known Flask routes to backend (security: only known routes)
    # Must come before catch-all location / to ensure proper matching
    location ~ ^/(public|userauth|api-keys|api|api-auth|metrics|actions|modules|wallet|transactions|get-db-data|test-jwt|health) {
        proxy_pass http://127.0.0.1:{{ item.backend_port }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Fallback: Proxy routes that don't match static file patterns (catches new API routes)
    # This matches paths that:
    # - Have at least one character after / (excludes root path /)
    # - Don't have common static file extensions (js, css, png, etc.)
    # - Don't start with known static directories (assets, downloads, sponsors, sim_players, ws)
    # - Don't match Flutter-specific files (main.dart.js, flutter.js, canvaskit, index.html)
    # Note: This uses negative lookahead patterns to exclude static files while allowing multi-segment API routes
    location ~ ^/(?!(assets|downloads|sponsors|sim_players|ws|main\.dart\.js|flutter\.js|canvaskit|index\.html))[^/].+(?!\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|html|json|wasm|bin|map)$) {
        proxy_pass http://127.0.0.1:{{ item.backend_port }};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Serve Flutter web application files (SPA routing support)
    location / {
        root {{ item.root_dir | default('/var/www/' + item.domain) }};
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # Cache static assets (JS, CSS, images, fonts)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # Cache Flutter main files
        location ~* ^/(main\.dart\.js|flutter\.js|canvaskit.*)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # Don't cache index.html (always get latest version)
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }
    {% else %}
    # Standard mode: Reverse proxy all requests to backend application (e.g. Flask in Docker)
    location / {
        proxy_pass http://127.0.0.1:{{ item.backend_port }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    {% endif %}
    {% else %}
    # Basic static-site location block
    location / {
        try_files $uri $uri/ =404;
    }
    {% endif %}

    # Static downloads directory for app binaries (e.g. APK/IPA)
    location /downloads/ {
        alias {{ item.root_dir | default('/var/www/' + item.domain) }}/downloads/;
        autoindex off;
        default_type application/octet-stream;
        add_header Content-Disposition "attachment";
    }

    # Security: deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # If you need to serve static files (uncomment and adjust)
    # location /static/ {
    #     alias /var/www/{{ item.domain }}/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }
}

# SSL configuration will be added automatically by Certbot
# After SSL setup, Certbot will modify this file to add:
# - listen 443 ssl;
# - SSL certificate paths
# - SSL redirect from HTTP to HTTPS
